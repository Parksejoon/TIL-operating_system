# IPC 시스템(Interprocess Communication System)
실제 IPC(Interprocess Communication)시스템은 어떻게 구성되어 있는가? POSIX API와 Mach, Windows에서의 IPC시스템은 어떻게 구성되어 있는지 설명되어 있다.
***

## POSIX 공유 메모리
* POSIX 공유 메모리는 메모리 매핑 파일을 사용한다.
    * shm_open 시스템 콜을 사용해 공유 메모리용 객체를 생성한다.
    * ftruncate 함수를 사용해 객체의 크기를 설정한다.
    * nmap 함수를 사용해 메모리 매핑 파일을 구축한다. 반환값으로 이 파일의 포인터를 반환한다.
    * 생산자는 공유 메모리 객체를 생성 및 쓰기를 하고, 소비자는 읽기를 한다.
    * shm_unlink 함수를 사용해 공유 메모리를 제거한다.

## Mach
* 대부분 메세지를 사용해 통신한다.
* 메세지의 메일박스를 포트(port)라고 부른다.
* 시스템 콜 또한 메세지를 사용한다.
    * 각 프로세스가 생성될 때, 커널(Kernel) 메일박스와 Notify 메일박스가 생성된다.
    * 커널 포트를 사용해 프로세스와 통신한다.
    * Notify 포트를 통해 이벤트의 발생을 통지한다.
* 메세지 전송은 시스템 콜을 이용한다.
    * msg_send는 메세지를 보냄
    * msg_receive는 메세지를 받음
    * msg_rpc는 원격 프로시저 호출을 함, 정확히 하나의 회신 메세지를 기다린다.
    * port_allocate 시스템 콜을 사용해 새로운 메일박스를 생성한다.
* 메일박스는 초기에 비어있는 메세지 큐를 갖는다.
* 메세지가 메일박스로 전송되면 메일박스로 복사를 한다.
* 메세지들은 고정 길이 헤더와 가변 길이의 자료 부분으로 구성된다.
    * 헤더에는 메세지의 길이와 보낼 목적지 메일박스, 회신을 받을 메일박스가 존재한다.
    * 가변 부분은 타입을 가진 자료의 리스트이다.
* 메일박스가 꽉 차있을때는 다양한 방법으로 처리한다
    * 메일박스에 공간이 생길 때 까지 무한히 대기한다.
    * 최대 시간을 정해두고 그 때 까지만 대기한다.
    * 기다리지 않고 복귀한다.
    * 마지막에 온 단 하나의 메세지만 캐시에 보관한다. 라인 프린터 드라이버 같은 서버 태스크를 위한 것 이다.
* 수신 연산은 메일박스 또는 메일박스의 집합을 지정해야 한다.
* 한 태스크내의 스레드들은 태스크가 수신 접근권한을 가진 메일박스에만 접근할 수 있다.
* port_status 시스템 콜은 주어진 메일박스내의 메세지 수를 반환한다.
* 수신은 목적지를 다음과 같이 둘 수 있다.
    * 임의의 메일박스
    * 지명된 메일박스
* 메세지 시스템들의 주된 문제점은 송신자와 수신자로부터 각각 1번씩 총 2번 복사를 한다는 것 이다.
    * 가상 메모리 관리 기법을 이용해 복사를 피하기도 한다.
    * 주소 공간으로 매핑을 하는 방법도 있다.

## Windows
* Windows에서 응용 프로그램은 메세지 전달 기법을 통해 다중 운영 환경 또는 서브시스템과 통신한다.
* Windows에서 메세지 전달 기능은 고급 로컬 프로시저 호출 기능(ALPC, Advanced Local Procedure Call Facility)이라 불린다.
* ALPC는 동일 기계 상에 있는 두 프로세스간의 통신에 사용한다.
* ALPC는 RPC기법과 같으나 Windows에 맞게 최적화 되어 있다.
* Windows 또한 포트를 사용한다.
    * 연결 포트(connection port)
    * 통신 포트(communication port)
* 서버 프로세스는 모든 프로세스가 접근할 수 있도록 연결 포트를 알려준다.
* 클라이언트 프로세스는 이 서버의 포트를 통해 연결 요청을 보낸다.
* 그러면 서버는 채널을 생성하고 핸들을 반환한다.
* 채널은 두 개의 통신 포트로 구성된다.
    * 클라이언트 -> 서버
    * 서버 -> 클라이언트
* 통신 채널은 콜백 기법또한 제공한다.
* ALPC 채널의 메세지 전달 기법은 3가지가 있다.
    * 256바이트까지의 메세지는 포트의 메세지 큐가 중간 저장소로 사용되고 메세지는 프로세스에서 프로세스로 복사된다.
    * 대용량 메세지는 섹션 객채(section object)를 통해 전달된다. 섹션 객체는 채널과 연관된 공유 메모리 영역을 뜻한다.
    * 섹션 객체를 사용할 수 없을 정도의 큰 데이터는 서버가 클라이언트 주소 공간을 직접 쓸 수 있는 API를 제공한다.
* ALPC는 Windows API의 일부기 때문에 응용 프로그래머가 사용할 수 없다.